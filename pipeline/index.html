<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Pipeline - Benthos</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">Benthos</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="https://www.benthos.dev">Home</a>
                            </li>
                            <li >
                                <a href="../concepts/">Concepts</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../inputs/">Inputs</a>
</li>
                                    
<li >
    <a href="../buffers/">Buffers</a>
</li>
                                    
<li >
    <a href="../processors/">Processors</a>
</li>
                                    
<li >
    <a href="../conditions/">Conditions</a>
</li>
                                    
<li >
    <a href="../outputs/">Outputs</a>
</li>
                                    
<li >
    <a href="../caches/">Caches</a>
</li>
                                    
<li >
    <a href="../rate_limits/">Rate Limits</a>
</li>
                                    
<li >
    <a href="../metrics/">Metrics</a>
</li>
                                    
<li >
    <a href="../tracers/">Tracers</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../getting_started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../cookbooks/">Cookbooks</a>
</li>
                                    
<li class="active">
    <a href="./">Pipeline</a>
</li>
                                    
<li >
    <a href="../batching/">Message Batching</a>
</li>
                                    
<li >
    <a href="../error_handling/">Error Handling</a>
</li>
                                    
<li >
    <a href="../workflows/">Workflows</a>
</li>
                                    
<li >
    <a href="../configuration/">Config Cheats</a>
</li>
                                    
<li >
    <a href="../config_interpolation/">Config Interpolation</a>
</li>
                                    
<li >
    <a href="../examples/">Applied Examples</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../cookbooks/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../batching/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#pipeline">Pipeline</a></li>
            <li><a href="#multiple-consumers">Multiple Consumers</a></li>
            <li><a href="#single-consumer">Single Consumer</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="pipeline">Pipeline</h1>
<p>Within a Benthos configuration, in between <code>input</code> and <code>output</code>, is a <code>pipeline</code>
section. This section describes an array of <a href="./processors">processors</a> that are to
be applied to <em>all</em> messages, and are not bound to any particular input or
output.</p>
<p>If you have processors that are heavy on CPU and aren't specific to a certain
input or output they are best suited for the pipeline section. It is
advantageous to use the pipeline section as it allows you to set an explicit
number of parallel threads of execution which should ideally match the number of
available logical CPU cores.</p>
<p>The following patterns allow you to achieve a distribution of work across these
processing threads for different input arrangments.</p>
<h3 id="multiple-consumers">Multiple Consumers</h3>
<p>Sometimes our source of data can have many multiple connected clients and will
distribute a stream of messages amongst them. In these circumstances it is
possible to fully utilise a set of parallel processing threads without a buffer,
provided that the number of consumers is greater than the number of threads.
Ideally the number of consumers would be significantly higher than the number of
threads in order to compensate for occasional IO stalls.</p>
<p>For example, imagine we are consuming from a source <code>baz</code>, which is
<a href="https://duckduckgo.com/?q=at+least+once">At-Least-Once</a> and supports multiple connected clients. Our goal is
to read the stream as fast as possible, perform mutations on the JSON payload
using the <a href="../processors/#jmespath">jmespath processor</a>, and write the resulting
stream to <code>bar</code>.</p>
<p>We also wish to take advantage of the delivery guarantees of the source and
therefore want acknowledgements to flow directly from our output sink to the
input source, and therefore need to avoid using a buffer.</p>
<p>For this purpose we would be able to utilise our processing threads without the
need for a buffer. We choose four processing threads to match our 4 CPU cores,
and choose to use eight parallel consumers of the input <code>baz</code>.</p>
<pre><code class="yaml">input:
  type: broker
  broker:
    copies: 8
    inputs:
    - type: baz
buffer:
  type: none
pipeline:
  threads: 4
  processors:
  - type: jmespath
    jmespath:
      query: &quot;reservations[].instances[].[tags[?Key=='Name'].Values[] | [0], type, state.name]&quot;
output:
  type: bar
</code></pre>

<p>With this config the pipeline within our Benthos instance would look something
like the following:</p>
<pre><code class="text">baz -\
baz -\
baz ---&gt; processor ---&gt; bar
baz ---&gt; processor -/
baz ---&gt; processor -/
baz ---&gt; processor -/
baz -/
baz -/
</code></pre>

<h3 id="single-consumer">Single Consumer</h3>
<p>Sometimes a source of data can only have a single consuming client. In these
circumstances it is still possible to have the single stream of data processed
on parallel processing threads by using a <a href="./buffers">buffer</a>.</p>
<p>For example, say we have an input stream <code>foo</code> with only a single connected
client. Our goal is to read the stream as fast as possible, perform mutations on
the JSON payload using the <a href="../processors/#jmespath">jmespath processor</a>, and write
the resulting stream to <code>bar</code>.</p>
<p>The messages from <code>foo</code> are <a href="https://duckduckgo.com/?q=at+most+once">At-Most-Once</a>, and so we are not
concerned with delivery guarantees and want to focus on performance instead. We
have four logical CPU cores on our server and wish to dedicate them all to
processing the data. We believe that the <code>bar</code> output will be fast enough to
keep up with the stream with a single connection.</p>
<p>We set our number of processing threads to four in order to match the CPU cores
available. We also chose a <code>memory</code> buffer since it is the fastest buffer
option, with a size of 5MB which we have determined to be more than enough to
fit four messages of the stream at any given time.</p>
<pre><code class="yaml">input:
  type: foo
buffer:
  type: memory
  memory:
    limit: 5000000
pipeline:
  threads: 4
  processors:
  - type: jmespath
    jmespath:
      query: &quot;reservations[].instances[].[tags[?Key=='Name'].Values[] | [0], type, state.name]&quot;
output:
  type: bar
</code></pre>

<p>With this config the pipeline within our Benthos instance would look something
like the following:</p>
<pre><code class="text">foo -&gt; memory buffer ---&gt; processor ---&gt; bar
          ( 5MB )    \--&gt; processor -/
                     \--&gt; processor -/
                     \--&gt; processor -/
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

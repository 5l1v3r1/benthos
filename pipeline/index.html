<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ashley Jeffs">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Processing Pipelines - Benthos</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css">
        <link href="../style/blobfish.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-135959729-3', 'docs.benthos.dev');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
  <a class="navbar-brand" href="https://www.benthos.dev">Benthos</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="/">Home</a>
                            </li>
                            <li >
                                <a href="../cookbooks/">Cookbooks</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../inputs/">Inputs</a>
</li>
                                    
<li >
    <a href="../buffers/">Buffers</a>
</li>
                                    
<li >
    <a href="../processors/">Processors</a>
</li>
                                    
<li >
    <a href="../conditions/">Conditions</a>
</li>
                                    
<li >
    <a href="../outputs/">Outputs</a>
</li>
                                    
<li >
    <a href="../caches/">Caches</a>
</li>
                                    
<li >
    <a href="../rate_limits/">Rate Limits</a>
</li>
                                    
<li >
    <a href="../metrics/">Metrics</a>
</li>
                                    
<li >
    <a href="../tracers/">Tracers</a>
</li>
                                    
<li >
    <a href="../logger/">Logger</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../getting_started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../serverless/">Serverless</a>
</li>
                                    
<li >
    <a href="../configuration/">Configuration</a>
</li>
                                    
<li >
    <a href="../configuration_testing/">Configuration Testing</a>
</li>
                                    
<li >
    <a href="../config_interpolation/">Config Interpolation</a>
</li>
                                    
<li class="active">
    <a href="./">Processing Pipelines</a>
</li>
                                    
<li >
    <a href="../batching/">Message Batching</a>
</li>
                                    
<li >
    <a href="../error_handling/">Error Handling</a>
</li>
                                    
<li >
    <a href="../performance_tuning/">Performance Tuning</a>
</li>
                                    
<li >
    <a href="../monitoring/">Monitoring</a>
</li>
                                    
<li >
    <a href="../sync_responses/">Synchronous Responses</a>
</li>
                                    
<li >
    <a href="../workflows/">Workflows</a>
</li>
                                    
<li >
    <a href="../streams/">Streams Mode</a>
</li>
                                    
<li >
    <a href="../examples/">Applied Examples</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
    <li class="nav-item">
      <a rel="prev" href="../config_interpolation/" class="nav-link">
        <i class="fa fa-arrow-left"></i>
      </a>
    </li>
    <li class="nav-item">
      <a rel="next" href="../batching/" class="nav-link">
        <i class="fa fa-arrow-right"></i>
      </a>
    </li>
    <li class="nav-item">
      <a href="https://github.com/Jeffail/benthos/" class="nav-link">
        <i class="fa fa-github"></i> Code
      </a>
    </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#processing-pipelines">Processing Pipelines</a></li>
            <li><a href="#multiple-consumers">Multiple Consumers</a></li>
            <li><a href="#single-consumer-without-buffer">Single Consumer Without Buffer</a></li>
            <li><a href="#single-consumer-with-buffer">Single Consumer With Buffer</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="processing-pipelines">Processing Pipelines</h1>
<p>Within a Benthos configuration, in between <code>input</code> and <code>output</code>, is a <code>pipeline</code> section. This section describes an array of <a href="../processors/">processors</a> that are to be applied to <em>all</em> messages, and are not bound to any particular input or output.</p>
<p>If you have processors that are heavy on CPU and aren't specific to a certain input or output they are best suited for the pipeline section. It is advantageous to use the pipeline section as it allows you to set an explicit number of parallel threads of execution which should ideally match the number of available logical CPU cores.</p>
<p>For example, imagine we are consuming from a source <code>foo</code>. Our goal is to consume the stream as fast as possible, perform mutations on the JSON payload using the <a href="../processors/#jmespath"><code>jmespath</code> processor</a>, and write the resulting stream to a sink <code>bar</code>. The following patterns allow you to achieve a distribution of work across these processing threads for maximum horizontal scaling.</p>
<h3 id="multiple-consumers">Multiple Consumers</h3>
<p>Sometimes our source of data can have many multiple connected clients and will distribute a stream of messages amongst them. In these circumstances it is possible to fully utilise a set of parallel processing threads by configuring the number of consumers to be greater than or equal to the number of threads. Ideally the number of consumers would be slightly higher than the number of threads in order to compensate for occasional IO stalls.</p>
<p>We can configure this arrangement with a <a href="../inputs/#broker"><code>broker</code> input</a>:</p>
<pre><code class="yaml">input:
  broker:
    copies: 8
    inputs:
      - type: foo
buffer:
  type: none
pipeline:
  threads: 4
  processors:
    - jmespath:
        query: &quot;reservations[].instances[].[tags[?Key=='Name'].Values[] | [0], type, state.name]&quot;
output:
  type: bar
</code></pre>

<p>With this config the pipeline within our Benthos instance would look something like the following:</p>
<pre><code class="text">baz -\
baz -\
baz ---&gt; processors ---&gt; bar
baz ---&gt; processors -/
baz ---&gt; processors -/
baz ---&gt; processors -/
baz -/
baz -/
</code></pre>

<p>The disadvantage of this set up is that increasing the number of consuming clients potentially puts unnecessary stress on your data source.</p>
<h3 id="single-consumer-without-buffer">Single Consumer Without Buffer</h3>
<p>Sometimes a source of data can only have a single consuming client. In these circumstances it is still possible to have the single stream of data processed on parallel processing threads and preserve our delivery guarantees. For this purpose we can do a batch and split:</p>
<pre><code class="yaml">input:
  kafka_balanced:
    addresses: [ TODO ]
    topics: [ foo, bar ]
    consumer_group: foogroup
    max_batch_count: 100
  processors:
    - split:
        size: 25
pipeline:
  threads: 4
  processors:
    - jmespath:
        query: &quot;reservations[].instances[].[tags[?Key=='Name'].Values[] | [0], type, state.name]&quot;
output:
  type: bar
</code></pre>

<p>When a batch at the input level is split into N smaller batches Benthos will automatically dispatch those batches in parallel across your processing threads. This action preserves transaction based resiliency. Most inputs have a native way of batching documents, if that is not the case you can precede your <a href="../processors/#split"><code>split</code> processor</a> with a <a href="../processors/#batch"><code>batch</code> processor</a>.</p>
<p>With this config the pipeline within our Benthos instance would look something like the following:</p>
<pre><code class="text">                  Batch       Split
kafka_balanced -&gt; ######## -&gt; ## ---&gt; processors ---&gt; bar
                              ## \--&gt; processors -/
                              ## \--&gt; processors -/
                              ## \--&gt; processors -/
</code></pre>

<p>However, this pattern caps the processing time of a whole batch with the slowest processing time of the split batches, as they are locked within a transaction. If there is wide variance in the expected processing time of message batches then it's possible to mitigate this effect by combining this pattern with the previous, allowing you to utilise all threads even when the number of brokered inputs is less than the thread count.</p>
<h3 id="single-consumer-with-buffer">Single Consumer With Buffer</h3>
<p>Sometimes batching documents up isn't a viable option, but we can still only have a single consuming client. In these circumstances it is possible to have the single stream of data processed on parallel processing threads by using a <a href="../buffers/">buffer</a>:</p>
<pre><code class="yaml">input:
  type: foo
buffer:
  memory:
    limit: 5000000
pipeline:
  threads: 4
  processors:
    - jmespath:
        query: &quot;reservations[].instances[].[tags[?Key=='Name'].Values[] | [0], type, state.name]&quot;
output:
  type: bar
</code></pre>

<p>With this config the pipeline within our Benthos instance would look something like the following:</p>
<pre><code class="text">foo -&gt; memory buffer ---&gt; processors ---&gt; bar
          ( 5MB )    \--&gt; processors -/
                     \--&gt; processors -/
                     \--&gt; processors -/
</code></pre>

<p>However, using a buffer weakens the delivery guarantees that Benthos provides, making data loss possible during system crashes or disk corruption. This is less of a concern when your source of data is <a href="https://duckduckgo.com/?q=at+most+once">at-most-once</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

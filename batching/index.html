<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ashley Jeffs">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Message Batching - Benthos</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css">
        <link href="../style/blobfish.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-135959729-3', 'docs.benthos.dev');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
  <a class="navbar-brand" href="https://www.benthos.dev">Benthos</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="/">Home</a>
                            </li>
                            <li >
                                <a href="../cookbooks/">Cookbooks</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../inputs/">Inputs</a>
</li>
                                    
<li >
    <a href="../buffers/">Buffers</a>
</li>
                                    
<li >
    <a href="../processors/">Processors</a>
</li>
                                    
<li >
    <a href="../conditions/">Conditions</a>
</li>
                                    
<li >
    <a href="../outputs/">Outputs</a>
</li>
                                    
<li >
    <a href="../caches/">Caches</a>
</li>
                                    
<li >
    <a href="../rate_limits/">Rate Limits</a>
</li>
                                    
<li >
    <a href="../metrics/">Metrics</a>
</li>
                                    
<li >
    <a href="../tracers/">Tracers</a>
</li>
                                    
<li >
    <a href="../logger/">Logger</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../getting_started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../serverless/">Serverless</a>
</li>
                                    
<li >
    <a href="../configuration/">Configuration</a>
</li>
                                    
<li >
    <a href="../configuration_testing/">Configuration Testing</a>
</li>
                                    
<li >
    <a href="../config_interpolation/">Config Interpolation</a>
</li>
                                    
<li >
    <a href="../pipeline/">Processing Pipelines</a>
</li>
                                    
<li class="active">
    <a href="./">Message Batching</a>
</li>
                                    
<li >
    <a href="../error_handling/">Error Handling</a>
</li>
                                    
<li >
    <a href="../performance_tuning/">Performance Tuning</a>
</li>
                                    
<li >
    <a href="../monitoring/">Monitoring</a>
</li>
                                    
<li >
    <a href="../sync_responses/">Synchronous Responses</a>
</li>
                                    
<li >
    <a href="../workflows/">Workflows</a>
</li>
                                    
<li >
    <a href="../streams/">Streams Mode</a>
</li>
                                    
<li >
    <a href="../examples/">Applied Examples</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
    <li class="nav-item">
      <a rel="prev" href="../pipeline/" class="nav-link">
        <i class="fa fa-arrow-left"></i>
      </a>
    </li>
    <li class="nav-item">
      <a rel="next" href="../error_handling/" class="nav-link">
        <i class="fa fa-arrow-right"></i>
      </a>
    </li>
    <li class="nav-item">
      <a href="https://github.com/Jeffail/benthos/" class="nav-link">
        <i class="fa fa-github"></i> Code
      </a>
    </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#message-batching">Message Batching</a></li>
            <li><a href="#creating-batches">Creating Batches</a></li>
            <li><a href="#archiving-batches">Archiving Batches</a></li>
            <li><a href="#processing-batches">Processing Batches</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="message-batching">Message Batching</h1>
<p>Benthos is able to read and write over protocols that support multiple part
messages, and all payloads travelling through Benthos are represented as a
multiple part message. Therefore, all components within Benthos are able to work
with multiple parts in a message as standard.</p>
<p>When messages reach an output that <em>doesn't</em> support multiple parts the message
is broken down into an individual message per part, and then one of two
behaviours happen depending on the output. If the output supports batch sending
messages then the collection of messages are sent as a single batch. Otherwise,
Benthos falls back to sending the messages sequentially in multiple, individual
requests.</p>
<p>This behaviour means that not only can multiple part message protocols be easily
matched with single part protocols, but also the concept of multiple part
messages and message batches are interchangeable within Benthos.</p>
<h2 id="creating-batches">Creating Batches</h2>
<p>Most input types have some way of creating batches of messages from their feeds.
These input specific methods are usually the most efficient and should therefore
be preferred.</p>
<h3 id="batch-policy">Batch Policy</h3>
<p>When an input component has a config field <code>batching</code> that means it supports
a batch policy. This is a mechanism that allows you to configure exactly how
your batching should work.</p>
<p>Batches are considered complete and will be flushed downstream when either of
the following conditions are met:</p>
<ul>
<li>The <code>byte_size</code> field is non-zero and the total size of the batch in
  bytes matches or exceeds it (disregarding metadata.)</li>
<li>The <code>count</code> field is non-zero and the total number of messages in
  the batch matches or exceeds it.</li>
<li>A message added to the batch causes the <a href="../conditions/"><code>condition</code></a> to resolve
  to <code>true</code>.</li>
<li>The <code>period</code> field is non-empty and the time since the last batch exceeds its
  value.</li>
</ul>
<h3 id="other-fields">Other Fields</h3>
<p>Sometimes an input doesn't support batch policies but has other less powerful
ways of aggregating batches. For example, the <a href="../inputs/#kafka"><code>kafka</code></a> input has the
field <code>max_batch_count</code>, which specifies the maximum count of prefetched
messages each batch should contain (defaults at 1).</p>
<h3 id="batch-processors">Batch Processors</h3>
<p>Alternatively, there are also <a href="../processors/">processors</a> within Benthos that can
expand and contract batches, these are the <a href="../processors/#batch"><code>batch</code></a> and <a href="../processors/#split"><code>split</code></a>
processors.</p>
<p>The <code>batch</code> processor follows the same rules as any other
<a href="#batch-policy">batch policy</a>. However, the rules are only checked when a new
message is added, meaning a pending batch can last beyond the specified period
if no messages are added since the period was reached.</p>
<p>As messages are read and stored within a batch processor the input they
originated from is told to grab the next message but defer from acknowledging
the current one, this allows the entire batch of messages to be acknowledged at
the same time and only when they have reached their final destination.</p>
<p>It is good practice to always expand or contract batches within the <code>input</code>
section. Like this, for example:</p>
<pre><code class="yaml">input:
  broker:
    inputs:
    - type: foo
    - type: bar
  processors:
  - batch:
      byte_size: 20_000_000
</code></pre>

<p>You should <em>never</em> configure processors that remove payloads (<code>filter</code>,
<code>dedupe</code>, etc) before a batch processor as this can potentially break
acknowledgement propagation. Instead, always batch first and then configure your
processors <a href="#processing-batches">to work with the batch</a>.</p>
<h2 id="archiving-batches">Archiving Batches</h2>
<p>Batches of messages can be condensed into a single message part using a selected
scheme such as <code>tar</code> with the <a href="../processors/#archive"><code>archive</code></a> processor, the opposite is
also possible with the <a href="../processors/#unarchive"><code>unarchive</code></a> processor.</p>
<p>This allows you to send and receive message batches over protocols that do not
support batching or multiple part messages.</p>
<h2 id="processing-batches">Processing Batches</h2>
<p>Most processors will perform the same action on each message part of a batch,
and therefore they behave the same regardless of whether they see a single
message or a batch of plenty.</p>
<p>However, some processors act on an entire batch and this might be undesirable.
For example, imagine we batch our messages for the purpose of throughput
optimisation but also need to perform deduplication on the payloads. The
<code>dedupe</code> processor works batch wide, so in this case we need to force the
processor to work as though each batched message is its own batch. We can do
this with the <a href="../processors/#for_each"><code>for_each</code></a> processor:</p>
<pre><code class="yaml">input:
  type: foo
  processors:
  - batch:
      byte_size: 20_000_000
  - for_each:
    - dedupe:
        cache: foocache
        key: ${!json_field:foo.bar}
</code></pre>

<p>The <code>dedupe</code> processor will now treat all items of the batch as if it were a
batch of one message. Whatever messages result from the child processors will
continue as their own batch.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Workflows - Benthos</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../cookbooks/">Benthos</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="/">Home</a>
                            </li>
                            <li >
                                <a href="../cookbooks/">Cookbooks</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../inputs/">Inputs</a>
</li>
                                    
<li >
    <a href="../buffers/">Buffers</a>
</li>
                                    
<li >
    <a href="../processors/">Processors</a>
</li>
                                    
<li >
    <a href="../conditions/">Conditions</a>
</li>
                                    
<li >
    <a href="../outputs/">Outputs</a>
</li>
                                    
<li >
    <a href="../caches/">Caches</a>
</li>
                                    
<li >
    <a href="../rate_limits/">Rate Limits</a>
</li>
                                    
<li >
    <a href="../metrics/">Metrics</a>
</li>
                                    
<li >
    <a href="../tracers/">Tracers</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../getting_started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../pipeline/">Processing Pipelines</a>
</li>
                                    
<li >
    <a href="../batching/">Message Batching</a>
</li>
                                    
<li >
    <a href="../error_handling/">Error Handling</a>
</li>
                                    
<li class="active">
    <a href="./">Workflows</a>
</li>
                                    
<li >
    <a href="../configuration/">Config Cheats</a>
</li>
                                    
<li >
    <a href="../config_interpolation/">Config Interpolation</a>
</li>
                                    
<li >
    <a href="../examples/">Applied Examples</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../error_handling/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../configuration/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#workflows-in-benthos">Workflows in Benthos</a></li>
            <li><a href="#the-problem">The Problem</a></li>
            <li><a href="#automatic-dag-resolution">Automatic DAG Resolution</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="workflows-in-benthos">Workflows in Benthos</h1>
<h2 id="the-problem">The Problem</h2>
<p>A workflow is often expressed as a <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a> of processing stages, where
each stage can result in N possible next stages, until finally the flow ends at
an exit node.</p>
<p>For example, if we had processing stages A, B, C and D, where stage A could
result in either stage B or C being next, always followed by D, it might look
something like this:</p>
<pre><code class="text">     /--&gt; B --\
A --|          |--&gt; D
     \--&gt; C --/
</code></pre>

<p>This flow would be easy to express in a standard Benthos config, we could simply
use a <a href="../processors/#conditional"><code>conditional</code></a> processor to route to either B or C depending
on a condition on the result of A. However, this method of flow control quickly
becomes unfeasible as the DAG gets more complicated, imagine expressing this
flow using conditional or switch processors:</p>
<pre><code class="text">      /--&gt; B -------------|--&gt; D
     /                   /
A --|          /--&gt; E --|
     \--&gt; C --|          \
               \----------|--&gt; F
</code></pre>

<p>And imagine doing so knowing that the diagram is subject to change over time.
Yikes!</p>
<h2 id="automatic-dag-resolution">Automatic DAG Resolution</h2>
<p>Benthos comes with a workflow solution called the <a href="../processors/#process_dag"><code>process_dag</code></a>
processor, which takes a map of <a href="../processors/#process_map"><code>process_map</code></a> processors and
calculates the DAG by creating a dependency tree based on their mappings.</p>
<p>This method allows you to build your workflow without having to explicitly
define (or even know) the final order of stages. Instead, you define how each
individual stage mutates the original document and Benthos automatically
resolves the necessary execution order, including parallel execution of stages
within the same dependency tier.</p>
<p>For more information regarding these processors please check their respective
documentation.</p>
<h3 id="example">Example</h3>
<p>Concepts like these are much easier to explain with a simple example, so let's
define our workflow stages.</p>
<p>We are starting off with arbitrary JSON documents and want to make some HTTP
requests to a series of enrichment services where the end result will be placed
within the original JSON document at the path <code>tmp.enrichments</code>.</p>
<p>The enrichment services, depending on the contents of the original payload, will
return content that might need to be fed into a subsequent enrichment service in
order to obtain the final result we are looking for.</p>
<p>Some of these services might fail due to the contents of the original message,
in which case we want to send the full contents to a recovery service that will
attempt to recover a fallback version of the goal enrichment.</p>
<p>The enrichment stages can be described as:</p>
<hr />
<p>A) Perform an HTTP request to <code>fooserve</code> with the full message payload as the
contents. The response can be one of the following:</p>
<ol>
<li>200: <code>{"type":"bar","bar":{"some":"fields"}}</code></li>
<li>200: <code>{"type":"baz","baz":{"some":"fields"}}</code></li>
<li>400: Bad request</li>
</ol>
<hr />
<p>B) Perform an HTTP request to <code>barserve</code> with the object <code>bar</code> taken from the
output of stage A response 1. The response can be one of the following:</p>
<ol>
<li>200: <code>{"type":"baz","baz":{"some":"fields"}}</code></li>
<li>400: Bad request</li>
</ol>
<hr />
<p>C) Perform an HTTP request to <code>bazserve</code> with the object <code>baz</code> taken either from
the output of stage A response 2 or stage B response 1. The response can be one
of the following:</p>
<ol>
<li>200: <code>{"type":"qux","qux":{"some":"fields"}}</code></li>
<li>400: Bad request</li>
</ol>
<hr />
<p>D) If any previous stage returns a 400 then we perform an HTTP request to
<code>recoverserve</code> with the full message payload as the contents. The response will
always be the following:</p>
<ol>
<li>200: <code>{"type":"qux","qux":{"default":"fields"}}</code></li>
</ol>
<hr />
<p>E) Place the final contents (the object at <code>qux</code>) in the document at
<code>tmp.enrichments.qux</code>.</p>
<hr />
<p>A diagram for this flow might look like this:</p>
<pre><code class="text">      /--------|--&gt; C --|----------------|-&gt; E
     /        /          \              /
A --|--&gt; B --|            \            /
     \        \            \          /
      \--------|------------|--&gt; D --|
</code></pre>

<p>For simplicity we will attempt each HTTP request three times and interpret any
failure after those attempts as the equivalent of a <code>400</code> status code.</p>
<h4 id="stage-a">Stage A</h4>
<p>There's no need for a premap since we are sending the entire original payload.
The postmap targets are either the object <code>bar</code> or <code>baz</code>, and both are optional
since we aren't sure which will be present.</p>
<pre><code class="yaml">processors:
- type: http
  http:
    parallel: true
    request:
      url: http://fooserve/enrich
      verb: POST
      headers:
        Content-Type: application/json
      backoff_on: [ 429 ]
      drop_on: [ 400 ]
      retries: 3
postmap_optional:
  tmp.enrichments.bar: bar
  tmp.enrichments.baz: baz
</code></pre>

<h4 id="stage-b">Stage B</h4>
<p>The premap for stage B is <code>tmp.enrichments.bar</code> which if not present in the
payload results in this stage being skipped. Stage A is the only stage that
provides <code>tmp.enrichments.bar</code> and Benthos will make sure stage A is run before
stage B. If we were to add more stages later on that might provide
<code>tmp.enrichments.bar</code> then they will also automatically be run before this
stage.</p>
<pre><code class="yaml">premap:
  .: tmp.enrichments.bar
processors:
- type: http
  http:
    parallel: true
    request:
      url: http://barserve/enrich
      verb: POST
      headers:
        Content-Type: application/json
      backoff_on: [ 429 ]
      drop_on: [ 400 ]
      retries: 3
postmap:
  tmp.enrichments.baz: baz
</code></pre>

<h4 id="stage-c">Stage C</h4>
<p>The premap for stage C is <code>tmp.enrichments.baz</code> which if not present in the
payload results in this stage being skipped. Since either stage A or A might
provide this target they will both be run before this stage.</p>
<pre><code class="yaml">premap:
  .: tmp.enrichments.baz
processors:
- type: http
  http:
    parallel: true
    request:
      url: http://bazserve/enrich
      verb: POST
      headers:
        Content-Type: application/json
      backoff_on: [ 429 ]
      drop_on: [ 400 ]
      retries: 3
postmap:
  tmp.enrichments.qux: qux
</code></pre>

<h4 id="stage-d">Stage D</h4>
<p>Stage D is unique since for this stage we need to send the entire contents of
the payload (which means no premap), but we still only wish to trigger this
stage once any other stage capable of providing <code>tmp.enrichments.qux</code> has
already been executed. Therefore, we add the field <code>dependencies</code> with
<code>tmp.enrichments.qux</code> as an explicit dependency.</p>
<p>We also only wish to execute this stage when <code>tmp.enrichments.qux</code> is missing
from the payload, therefore we add a condition that performs this check.</p>
<pre><code class="yaml">dependencies:
- tmp.enrichments.qux
conditions:
- type: jmespath
  jmespath:
    query: 'tmp.enrichments.qux == `null`'
processors:
- type: http
  http:
    parallel: true
    request:
      url: http://recoverserve/enrich
      verb: POST
      headers:
        Content-Type: application/json
      backoff_on: [ 429 ]
      drop_on: [ 400 ]
      retries: 3
postmap:
  tmp.enrichments.qux: qux
</code></pre>

<h4 id="stage-e">Stage E</h4>
<p>Stage E doesn't need writing explicitly since by the end of Stage D we should
already have our enrichment at <code>tmp.enrichments.qux</code>.</p>
<p>The final Benthos configuration might look something like this:</p>
<pre><code class="yaml">input:
  type: stdin # TODO

pipeline:
  processors:
  - type: process_dag
    process_dag:
      A:
        processors:
        - type: http
          http:
            parallel: true
            request:
              url: http://fooserve/enrich
              verb: POST
              headers:
                Content-Type: application/json
              backoff_on: [ 429 ]
              drop_on: [ 400 ]
              retries: 3
        postmap_optional:
          tmp.enrichments.bar: bar
          tmp.enrichments.baz: baz

      B:
        premap:
          .: tmp.enrichments.bar
        processors:
        - type: http
          http:
            parallel: true
            request:
              url: http://barserve/enrich
              verb: POST
              headers:
                Content-Type: application/json
              backoff_on: [ 429 ]
              drop_on: [ 400 ]
              retries: 3
        postmap:
          tmp.enrichments.baz: baz

      C:
        premap:
          .: tmp.enrichments.baz
        processors:
        - type: http
          http:
            parallel: true
            request:
              url: http://bazserve/enrich
              verb: POST
              headers:
                Content-Type: application/json
              backoff_on: [ 429 ]
              drop_on: [ 400 ]
              retries: 3
        postmap:
          tmp.enrichments.qux: qux

      D:
        dependencies:
        - tmp.enrichments.qux
        conditions:
        - type: jmespath
          jmespath:
            query: 'tmp.enrichments.qux == `null`'
        processors:
        - type: http
          http:
            parallel: true
            request:
              url: http://recoverserve/enrich
              verb: POST
              headers:
                Content-Type: application/json
              backoff_on: [ 429 ]
              drop_on: [ 400 ]
              retries: 3
        postmap:
          tmp.enrichments.qux: qux

output:
  type: stdout # TODO
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

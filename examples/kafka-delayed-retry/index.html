<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ashley Jeffs">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Kafka delayed retry - Benthos</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-135959729-3', 'docs.benthos.dev');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
  <a class="navbar-brand" href="https://www.benthos.dev">Benthos</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="/">Home</a>
                            </li>
                            <li >
                                <a href="../../cookbooks/">Cookbooks</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Components <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../inputs/">Inputs</a>
</li>
                                    
<li >
    <a href="../../buffers/">Buffers</a>
</li>
                                    
<li >
    <a href="../../processors/">Processors</a>
</li>
                                    
<li >
    <a href="../../conditions/">Conditions</a>
</li>
                                    
<li >
    <a href="../../outputs/">Outputs</a>
</li>
                                    
<li >
    <a href="../../caches/">Caches</a>
</li>
                                    
<li >
    <a href="../../rate_limits/">Rate Limits</a>
</li>
                                    
<li >
    <a href="../../metrics/">Metrics</a>
</li>
                                    
<li >
    <a href="../../tracers/">Tracers</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../getting_started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../../serverless/">Serverless</a>
</li>
                                    
<li >
    <a href="../../configuration/">Configuration</a>
</li>
                                    
<li >
    <a href="../../config_interpolation/">Config Interpolation</a>
</li>
                                    
<li >
    <a href="../../pipeline/">Processing Pipelines</a>
</li>
                                    
<li >
    <a href="../../batching/">Message Batching</a>
</li>
                                    
<li >
    <a href="../../error_handling/">Error Handling</a>
</li>
                                    
<li >
    <a href="../../performance_tuning/">Performance Tuning</a>
</li>
                                    
<li >
    <a href="../../monitoring/">Monitoring</a>
</li>
                                    
<li >
    <a href="../../workflows/">Workflows</a>
</li>
                                    
<li >
    <a href="../../streams/">Streams Mode</a>
</li>
                                    
<li >
    <a href="../">Applied Examples</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
    <li class="nav-item">
      <a href="https://github.com/Jeffail/benthos/" class="nav-link">
        <i class="fa fa-github"></i> Code
      </a>
    </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#kafka-delayed-retry">Kafka Delayed Retry</a></li>
            <li><a href="#the-enrichment-stream">The Enrichment Stream</a></li>
            <li><a href="#the-retry-stream">The Retry Stream</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="kafka-delayed-retry">Kafka Delayed Retry</h1>
<h2 id="the-enrichment-stream">The Enrichment Stream</h2>
<p>We are consuming a Kafka stream of documents and wish to apply an enrichment to
each item of the stream via an HTTP service. If the enrichment fails for a
document then we wish to send the data to a different destination than
successful documents such that the enrichment can be retried on a delay by a
component down stream.</p>
<p>In order to do this we are going to use the <a href="../../processors/#catch"><code>catch</code></a> processor as
our <a href="../../error_handling/#recover-failed-messages">error recovery handling</a> mechanism. In order to
dynamically route documents we will use <a href="../../config_interpolation/#functions">function interpolation</a> to
base the output topic on metadata, which we can set dynamically via our recovery
mechanism.</p>
<pre><code class="yaml">input:
  kafka_balanced:
    addresses:
    - TODO
    topics:
    - source-queue
    consumer_group: enrichment-consumer
    max_batch_count: 20

pipeline:
  processors:
  - metadata:
      operator: set
      set: output_topic
      value: enriched-queue

  - http:
      parallel: true
      request:
        url: TODO
        verb: POST
        retries: 3

  - catch:
    - metadata:
        operator: set
        set: output_topic
        value: retry-queue

output:
  kafka:
    addresses:
    - TODO
    topic: &quot;${!metadata:output_topic}&quot;
</code></pre>

<p>We start our processing steps by setting all documents to have a metadata key
<code>output_topic</code> set to <code>enriched-queue</code>, which is where successfully enriched
documents should go.</p>
<p>We then do an HTTP request with the <a href="../../processors/#http"><code>http</code></a> processor which performs
our enrichment. In reality it would likely be more useful to wrap this step in a
<a href="../../processors/#process_map"><code>process_map</code></a> processor but the error handling mechanism would be
the same.</p>
<p>After our enrichment the documents will either be enriched or will be flagged as
having <a href="../../error_handling/#processor-errors">failed a processing step</a>, which means we can
perform processors specifically only on failed documents with the
<a href="../../processors/#catch"><code>catch</code></a> processor. We use this to set the metadata field
<code>output_topic</code> to <code>retry-queue</code> only for failed documents.</p>
<p>Finally, our output topic is a <a href="../../config_interpolation/#functions">function interpolation</a> string
<code>${!metadata:output_topic}</code> which resolves dynamically to the contents of the
metadata key <code>output_topic</code> for each document. Most output types have a similar
way of dynamically routing documents, otherwise you could use the
<a href="../../outputs/#switch"><code>switch</code></a> or <a href="../../outputs/#broker"><code>broker</code></a> outputs to multiplex the documents.</p>
<h2 id="the-retry-stream">The Retry Stream</h2>
<p>We now wish to reconsume and reprocess the failed documents from the above
pipeline, but only after 3600 seconds since the data was first consumed. This
time period can be calculated by referring to a timestamp within the JSON
document at the path <code>meta.created_at</code>.</p>
<p>We can do this by combining the <a href="../../processors/#awk"><code>awk</code></a> processor with the
<a href="../../processors/#sleep"><code>sleep</code></a> processor, using <code>awk</code> to calculate our target sleep
period:</p>
<pre><code class="yaml">input:
  kafka_balanced:
    addresses:
    - TODO
    topics:
    - retry-queue
    consumer_group: retry-consumer
    max_batch_count: 20

pipeline:
  processors:
  - awk:
      codec: json
      program: |
        {
          delay_for = 3600 - (timestamp_unix() - timestamp_unix(meta_created_at))
          if ( delay_for &lt; 0 )
            delay_for = 0

          metadata_set(&quot;delay_for_s&quot;, delay_for)
        }

  - type: sleep
    sleep:
      duration: &quot;${!metadata:delay_for_s}s&quot;

  # TODO: Reprocess

output:
  type: TODO
</code></pre>

<p>This works because the <code>awk</code> processor codec is set to <code>json</code>, meaning the
document is parsed as a JSON object, walked, and all fields found are set as
variables, allowing them to be referred to within the AWK program.</p>
<p>The <code>awk</code> processor also <a href="../../processors/awk_functions/#metadata-functions">has functions</a> for setting metadata,
which is used for writing our calculated sleep period. We do not print anything
with our AWK program as we do not wish to modify the contents of the document.</p>
<p>The <code>sleep</code> processor then simply halts the pipeline for a duration determined
through function interpolation, allowing us to specify it via the metadata key
we set.</p>
<p>After reprocessing we can multiplex the documents that still failed the retry
stage to a dead-letter queue similar to the first pipeline.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
